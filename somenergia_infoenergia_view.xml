<?xml version="1.0" encoding="utf-8"?>
<openerp>
    <data>
        <!-- Definim el menú arrel del mòdul de Infoenergia -->
        <menuitem id="menu_principal" name="InfoEnergia"/>
        <!-- Menú de configuració mòdul listado de informes -->
        <menuitem id="menu_configuracio" name="Listado Informes" parent="menu_principal" sequence="1"/>
        <!-- Vista formulari d'un polisses -->
        <record model="ir.ui.view" id="view_polisses_form">
            <field name="name">giscedata.polissa.form</field>
            <field name="model">giscedata.polissa</field>
            <field name="type">form</field>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <form string="polisses">
                    <group attrs="{'invisible': [('state', '!=', 'tall')]}" col="14">
                        <group colspan="6"/>
                        <group colspan="2" attrs="{'invisible': [('state', '!=','tall')]}" name="group_state_tall">
                            <image name="gtk-cut"/>
                            <label fill="1" string="&lt;b&gt;Atenció!&lt;/b&gt; aquest contracte està en estat Tall"/>
                        </group>
                        <group colspan="6"/>
                    </group>
                    <group attrs="{'invisible': [('state', '!=', 'baixa')]}" col="14">
                        <group colspan="4"/>
                        <group colspan="2" attrs="{'invisible': [('state', '!=','baixa')]}">
                            <image name="gtk-stop"/>
                            <label fill="1" string="&lt;b&gt;Atenció!&lt;/b&gt; aquest contracte està en estat Baixa"/>
                        </group>
                        <group colspan="8"/>
                    </group>
                    <group string="General" colspan="6" col="6">
                        <field name="name" attrs="{'readonly': [('name_auto', '=', 1)], 'required': [('name_auto', '!=', 1)]}"/>
                        <group colspan="2">
                            <field name="name_auto" attrs="{'readonly': [('name', '!=', False)]}"/>
                            <field name="data_firma_contracte" select="2"/>
                        </group>
                        <group col="2" rowspan="4" name="renovacio">
                            <field name="active" select="1"/>
                            <field name="renovacio_auto" select="2" attrs="{'readonly': [('data_baixa', '!=', False)]}"/>
                            <field name="data_alta" select="2"/>
                            <field name="data_baixa" select="2" on_change="onchange_data_baixa(data_baixa, context)" attrs="{'required': [('renovacio_auto', '=', 0)], 'readonly': [('renovacio_auto', '=', 1)]}"/>
                        </group>
                        <field name="titular" colspan="2" select="1" domain="[('customer', '=', 1)]"/>
                        <field name="cnae" select="2"/>
                    </group>
                    <notebook colspan="6">
                        <page string="General">
                            <separator string="Cups" colspan="4"/>
                            <field name="cups" select="1" size="25"/>
                            <field name="cups_direccio" colspan="4" select="1"/>
                            <field name="cups_cp" invisible="1" select="2"/>
                            <field name="cups_poblacio" invisible="1" select="2"/>
                            <separator string="Dades tècniques" colspan="4"/>
                            <group col="2" colspan="2">
                                <field name="contract_type" select="2"/>
                                <field name="tarifa" on_change="onchange_potencia(potencia, tarifa, context)" select="1"/>
                                <group colspan="2" col="4">
                                    <field name="potencia" select="1" on_change="onchange_potencia(potencia, tarifa, context)"/>
                                    <button name="%(action_wizard_set_normalized_power_form)s" type="action" string="Normalitzar" context="{'power': potencia, 'tarifa_id': tarifa, 'tensio_id': tensio_normalitzada, 'model': 'giscedata.polissa', 'field': 'potencia'}" states="esborrany,validar,modcontractual"/>
                                </group>
                                <field name="tensio_normalitzada" select="2" on_change="onchange_tensio(tensio_normalitzada, tarifa, context)"/>
                                <field name="tensio"/>
                                <field name="tg" select="2"/>
                                <field name="autoconsumo" select="2"/>
                                <field name="nocutoff"/>
                            </group>
                            <group col="2" colspan="2">
                                <field name="potencies_periode" colspan="4" nolabel="1">
                                    <tree string="Potències">
                                        <field name="periode_id"/>
                                        <field name="potencia"/>
                                    </tree>
                                    <form string="Potència">
                                        <field name="periode_id" readonly="1"/>
                                        <field name="potencia"/>
                                    </form>
                                </field>
                                <button name="generar_periodes_potencia" states="esborrany,validar,modcontractual" string="Generar periodes" type="object" context="{'force_genpot': True}"/>
                            </group>
                            <group col="4" colspan="4" attrs="{'invisible':[('persona_fisica', '=', 'CI')]}" >
                            <separator string="Altres dades" colspan="4" />
                            </group>
                            <group col="4" colspan="2" attrs="{'invisible':[('persona_fisica', '=', 'CI')]}" >
                                <field name="tipus_vivenda" select="1"/>
                                <field name="persona_fisica" invisible="1"/>
                            </group>
                        </page>
                        <page string="Facturació"/>
                        <page string="Contactes">
                            <separator string="Titular" colspan="4"/>
                            <field name="titular_nif" select="1"/>
                        </page>
                        <page string="Modificacions contr.">
                            <field name="modcontractual_activa" search="1"/>
                            <field name="modcontractuals_ids" colspan="4" nolabel="1"/>
                        </page>
                        <page string="Observacions">
                            <label colspan="4" string="Les observacions que s'escriguin aquí queden historitzades en les modificacions contractuals. Cada modificació contractual fa una còpia de les observacions actuals."/>
                            <field name="observacions" nolabel="1" colspan="4" select="1"/>
                        </page>
                        <page string="Perfils">
                            <group colspan="2" col="4" string="Nivells d'agregació">
                                <separator string="Tensió" colspan="1"/>
                                <separator string="Tarifa" colspan="1"/>
                                <separator string="DH" colspan="1"/>
                                <separator string="Tipus" colspan="1"/>
                                <field name="agree_tensio" nolabel="1"/>
                                <field name="agree_tarifa" nolabel="1"/>
                                <field name="agree_dh" nolabel="1"/>
                                <field name="agree_tipus" nolabel="1"/>
                            </group>
                        </page>
                        <page string="Històric">
                            <field name="log_ids" colspan="4" nolabel="1"/>
                        </page>
                        <page string="Documents rel.">
                            <field name="related_attachments" colspan="4" nolabel="1"/>
                        </page>
                    </notebook>
                    <group colspan="2" col="4">
                        <field name="state" select="1"/>
                        <group col="15" colspan="2">
                            <button name="esborrany" string="Esborrany" states="validar,pendent"/>
                            <button name="cancelar" string="Cancel·lar" states="esborrany,activa" confirm="Està segur que vol cancel·lar aquesta pòlissa?"/>
                            <button name="baixa" string="Baixa" states="activa,impagament,tall"/>
                            <button name="impagament" string="Impagament" states="activa" confirm="Està segur que vol passar a estat d'impagament aquesta pòlissa?"/>
                            <button name="validar" string="Validar" states="esborrany"/>
                            <button name="activar" string="Activar" states="impagament,tall,cancelada"/>
                            <button name="to_draft" string="Passar a Esborrany" states="cancelada"/>
                            <button name="contracte" string="Activar" states="validar"/>
                            <button name="reactivar" string="Reactivar" states="baixa" confirm="Està segur que vol reactivar?"/>
                            <button name="tallar" string="Tallar" states="impagament" confirm="Està segur que vol passar a estat de tall aquesta pòlissa?"/>
                            <button name="modcontractual" string="Modificació contractual" states="activa"/>
                            <button name="undo_modcontractual" string="Desfer mod. contractual" states="modcontractual"/>
                        </group>
                    </group>
                </form>
            </field>
        </record>
        <!-- Vista arbre dels polisses -->
        <record model="ir.ui.view" id="view_polisses_tree">
            <field name="name">giscedata.polissa.tree</field>
            <field name="model">giscedata.polissa</field>
            <field name="type">tree</field>
            <field name="priority" eval="16"/>
            <field name="arch" type="xml">
                <tree string="polisses" colors="red:state in ['tall', 'baixa', 'cancelada']">
                    <field name="name"/>
                    <field name="cups"/>
                    <field name="state"/>
                    <field name="titular"/>
                    <field name="cups_direccio"/>
                    <field name="firmat" invisible="1" select="1"/>
                </tree>
            </field>
        </record>
        <record model="ir.ui.view" id="view_polisses_tree_nocutoff">
            <field name="name">giscedata.polissa.tree</field>
            <field name="model">giscedata.polissa</field>
            <field name="type">tree</field>
            <field name="priority" eval="99"/>
            <field name="inherit_id" ref="view_polisses_tree"/>
            <field name="extend">1</field>
            <field name="arch" type="xml">
                <field name="potencia" position="after">
                    <field name="nocutoff" select="1"/>
                </field>
            </field>
        </record>
        <!-- Acció per obrir el llistat de polisses -->
        <record model="ir.actions.act_window" id="action_polisses">
            <field name="name">Pòlisses</field>
            <field name="view_id" ref="view_polisses_tree"/>
            <field name="res_model">giscedata.polissa</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
        </record>
        <!-- Menú per llistar les polisses -->
        <menuitem id="menu_polisses" parent="menu_principal" name="Pòlisses" action="action_polisses"/>
        <record model="ir.actions.act_window" id="action_giscedata_polisses_nocutoff_domain_tree">
            <field name="name">Pòlisses no tallables</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">giscedata.polissa</field>
            <field name="view_type">form</field>
            <field name="domain">[('nocutoff', '!=', False)]</field>
            <field name="view_id" ref="view_polisses_tree_nocutoff"/>
        </record>
        <!-- Llistat de totes les polisses -->
        <record model="ir.actions.act_window" id="action_polisses_all">
            <field name="name">Totes les Pòlisses</field>
            <field name="view_id" ref="view_polisses_tree"/>
            <field name="res_model">giscedata.polissa</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
            <field name="context">{'active_test': False}</field>
        </record>
        <menuitem id="menu_polisses_all" parent="menu_principal" name="Totes les Pòlisses" action="action_polisses_all"/>
        <!-- Llista pels modcontractuals a form polissa-->
        <record model="ir.ui.view" id="view_modcontractuals_tree">
            <field name="name">giscedata.polissa.modcontractual.tree</field>
            <field name="model">giscedata.polissa.modcontractual</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Modificacions contractuals" colors="red:active==0">
                    <field name="name"/>
                    <field name="tipus"/>
                    <field name="data_inici"/>
                    <field name="data_final"/>
                    <field name="active"/>
                    <field name="state"/>
                </tree>
            </field>
        </record>

        <!-- Llistat per defecte dels logs -->
        <record model="ir.ui.view" id="giscedata_polissa_log_tree">
            <field name="name">giscedata.polissa.log.tree</field>
            <field name="model">giscedata.polissa.log</field>
            <field name="type">tree</field>
            <field name="arch" type="xml" >
                <tree string="Log tree">
                    <field name="polissa_id"/>
                    <field name="state"/>
                    <field name="change_date"/>
                    <field name="user_id"/>
                </tree>
            </field>
        </record>

        <!-- Formulari per defecte del log -->
        <record model="ir.ui.view" id="giscedata_polissa_log_form">
            <field name="name">giscedata.polissa.log.form</field>
            <field name="model">giscedata.polissa.log</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Log form">
                    <field name="polissa_id" select="1"/>
                    <field name="state" select="1"/>
                    <field name="change_date" select="1"/>
                    <field name="user_id" select="1"/>
                </form>
            </field>
        </record>

        <!-- Llista de modificacions contractuals a llistat-->
        <record model="ir.ui.view" id="view_modcontractuals_tree_llistat">
            <field name="name">giscedata.polissa.modcontractual.tree.llistat</field>
            <field name="model">giscedata.polissa.modcontractual</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Modificacions contractuals" colors="red:active==0">
                    <field name="polissa_id"/>
                    <field name="name"/>
                    <field name="tipus"/>
                    <field name="data_inici"/>
                    <field name="data_final"/>
                    <field name="active"/>
                    <field name="state"/>
                    <field name="titular"/>
                    <field name="potencia"/>
                    <field name="tarifa"/>
                    <field name="tensio_normalitzada"/>
                </tree>
            </field>
        </record>
        <!-- Llista de modificacins contractuals amb observacions a llistat-->
        <record model="ir.ui.view" id="view_modcontractuals_amb_observacions_tree_llistat">
            <field name="name">giscedata.polissa.modcontractual.tree.llistat</field>
            <field name="model">giscedata.polissa.modcontractual</field>
            <field name="type">tree</field>
            <field name="priority">99</field>
            <field name="inherit_id" ref="view_modcontractuals_tree_llistat"/>
            <field name="extend">1</field>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='tensio_normalitzada']" position="after">
                    <field name="observacions"/>
                </xpath>
            </field>
        </record>
        <!--Acció per obrir les Modificacions Contractuals d'una polissa-->
        <record model="ir.actions.act_window" id="act_modcons_per_polissa">
            <field name="name">Modificacions Contractuals</field>
            <field name="res_model">giscedata.polissa.modcontractual</field>
            <field name="src_model">giscedata.polissa</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('polissa_id', '=', active_id)]</field>
            <field name="view_id" ref="view_modcontractuals_tree_llistat"/>
            <field name='context'>{'active_test': False}</field>
        </record>
        <record id="value_modcons_per_polissa" model="ir.values">
            <field name="object" eval="1"/>
            <field name="name">Modificacions Contractuals</field>
            <field name="key2">client_action_relate</field>
            <field name="key">action</field>
            <field name="model">giscedata.polissa</field>
            <field name="value" eval="'ir.actions.act_window,'+str(ref('act_modcons_per_polissa'))" />
        </record>
        <!-- Acció per obrir el llistat de Modificacions contractuals -->
        <record model="ir.actions.act_window" id="action_modcontractuals">
            <field name="name">Modificacions Contractuals</field>
            <field name="view_id" ref="view_modcontractuals_tree_llistat"/>
            <field name="res_model">giscedata.polissa.modcontractual</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
            <field name="context">{'active_test': False}</field>
        </record>
        <!-- Menú per llistar les modificacions contractuals -->
        <menuitem id="menu_modcons" parent="menu_polisses" name="Modificacions contractuals" action="action_modcontractuals"/>
        <!-- Acció per obrir el llistat de Modificacions contractuals amb observacions -->
        <record model="ir.actions.act_window" id="action_modcontractuals_amb_observacions">
            <field name="name">Modificacions Contractuals</field>
            <field name="view_id" ref="view_modcontractuals_amb_observacions_tree_llistat"/>
            <field name="res_model">giscedata.polissa.modcontractual</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
            <field name="context">{'active_test': False}</field>
        </record>
        <!-- Menú per llistar les modificacions contractuals amb observacions -->
        <menuitem id="menu_modcons_observacions" parent="menu_polisses" name="Modificacions contractuals amb observacions" action="action_modcontractuals_amb_observacions"/>
        <!-- Formulari per defecte de les tarifes -->
        <record model="ir.ui.view" id="view_tarifes_form">
            <field name="name">giscedata.polissa.tarifa.form</field>
            <field name="model">giscedata.polissa.tarifa</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Tarifa">
                    <field name="name" select="1"/>
                    <field name="codi_ocsum" readonly="1"/>
                    <field name="autogen_periodes_pot" select="2"/>
                    <field name="tipus" readonly="1"/>
                    <field name="active" readonly="1" select="1"/>
                    <separator string="Descripció" colspan="4"/>
                    <field name="descripcio" colspan="4" nolabel="1" readonly="1"/>
                    <field name="periodes" colspan="4" nolabel="1" readonly="1"/>
                </form>
            </field>
        </record>
        <!-- Formulari pels modcontractuals -->
        <record model="ir.ui.view" id="view_modcontractuals_form">
            <field name="name">giscedata.polissa.modcontractual.form</field>
            <field name="model">giscedata.polissa.modcontractual</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Modificacions contractuals">
                    <group colspan="4">
                        <group colspan="2" col="2" rowspan="1">
                            <field name="name"/>
                            <field name="polissa_id" select="1" readonly="1"/>
                            <field name="contract_type"/>
                        </group>
                        <group colspan="2" col="2" rowspan="1">
                            <field name="data_inici" select="1"/>
                            <field name="data_final" select="1"/>
                            <field name="data_firma_contracte"/>
                        </group>
                        <group colspan="2" col="4" rowspan="1">
                            <field name="state" select="1"/>
                            <field name="active" select="1"/>
                            <field name="tipus" select="1"/>
                        </group>
                        <group colspan="2" col="2" rowspan="1">
                            <field name="modcontractual_ant"/>
                            <field name="modcontractual_seg"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="Dades del client">
                            <field name="titular" colspan="4"/>
                            <field name="cnae"/>
                            <field name="tipus_vivenda" colspan="4"/>
                            <newline/>
                        </page>
                        <page string="Facturació"/>
                        <page string="CUPS">
                            <field name="cups" colspan="4"/>
                        </page>
                        <page string="Contactes">
                        </page>
                        <page string="Observacions">
                            <field name="observacions" colspan="4" nolabel="1"/>
                        </page>
                        <page string="Perfils">
                            <group colspan="2" col="4" string="Nivells d'agregació">
                                <separator string="Tensió" colspan="1"/>
                                <separator string="Tarifa" colspan="1"/>
                                <separator string="DH" colspan="1"/>
                                <separator string="Tipus" colspan="1"/>
                                <field name="agree_tensio" nolabel="1" select="2"/>
                                <field name="agree_tarifa" nolabel="1" select="2"/>
                                <field name="agree_dh" nolabel="1" select="2"/>
                                <field name="agree_tipus" nolabel="1" select="2"/>
                            </group>
                        </page>
                    </notebook>
                    <group string="Accions" colspan="4" col="8">
                        <button type="object" name="unlink" string="Cancel·lar" states="pendent" icon="gtk-delete"/>
                        <button type="action" name="%(wizard_print_c)d" string="Imprimir" icon="gtk-print"/>
                        <button type="action" name="%(action_wizard_canviar_dates_form)d" string="Canviar dates" icon="gtk-edit"/>
                        <button type="object" name="undo_last_modcontractual" string="Desfer mod. contractual" context="{'from_model': 'giscedata.polissa.modcontractual'}" attrs="{'invisible':[('state','!=','actiu')]}" confirm="Aquesta opció no es pot desfer. Vol continuar?"/>
                    </group>
                </form>
            </field>
        </record>
        <!-- Llistat per defecte de les tarifes -->
        <record model="ir.ui.view" id="view_infoenergia_polissa_tree">
            <field name="name">giscedata.polissa.tree</field>
            <field name="model">giscedata.polissa</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="polisses" colors="red:state in ['tall', 'baixa', 'cancelada']">
                    <field name="name"/>
                    <field name="data_firma_contracte"/>
                    <field name="cups"/>
                    <field name="state"/>
                    <field name="titular"/>
                    <field name="cups_direccio"/>
                    <field name="tarifa"/>
                    <field name="potencia"/>
                    <field name="tensio"/>
                    <field name="cnae"/>
                    <field name="tg"/>
                    <field name="autoconsumo"/>
                    <field name="firmat" invisible="1" select="1"/>
                </tree>
            </field>
        </record>
        <!-- Acció per obrir el llistat de tarifes -->
        <record model="ir.actions.act_window" id="action_listado">
            <field name="name">Test</field>
            <field name="view_id" ref="view_polisas_tree"/>
            <field name="res_model">giscedata.polissa</field>
            <field name="view_type">form</field>
            <field name="view_mode">form</field>
        </record>
        <!-- Menú per llistar les tarifes -->
        <menuitem id="menu_tarifes" parent="menu_configuracio" action="action_listado"/>
        <!-- Formulari per defecte dels periodes de les tarifes -->
        <record model="ir.ui.view" id="view_periodes_form">
            <field name="name">giscedata.polissa.tarifa.periodes.form</field>
            <field name="model">giscedata.polissa.tarifa.periodes</field>
            <field name="type">form</field>
            <field name="arch" type="xml">
                <form string="Periode">
                    <field name="name" select="1"/>
                    <field name="tarifa" select="1"/>
                    <field name="tipus" select="1"/>
                </form>
            </field>
        </record>
        <!-- Llistat per defecte dels periodes de les tarifes -->
        <record model="ir.ui.view" id="view_periodes_tree">
            <field name="name">giscedata.polissa.tarifa.periodes.tree</field>
            <field name="model">giscedata.polissa.tarifa.periodes</field>
            <field name="type">tree</field>
            <field name="arch" type="xml">
                <tree string="Periodes">
                    <field name="name"/>
                    <field name="tarifa"/>
                    <field name="tipus"/>
                </tree>
            </field>
        </record>
    </data>
</openerp>
